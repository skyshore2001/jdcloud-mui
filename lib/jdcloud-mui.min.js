// jdcloud-mui version 1.1

jdModule("jdcloud.common",JdcloudCommon);function JdcloudCommon()
{var self=this;self.assert=assert;function assert(cond,dscr)
{if(!cond){var msg="!!! assert fail!";if(dscr)
msg+=" - "+dscr;throw(msg);}}
self.parseQuery=parseQuery;function parseQuery(s)
{var ret={};if(s!="")
{var a=s.split('&')
for(i=0;i<a.length;++i){var a1=a[i].split("=");var val=a1[1];if(val===undefined)
val=1;else if(/^-?[0-9]+$/.test(val)){val=parseInt(val);}
else if(/^-?[0-9.]+$/.test(val)){val=parseFloat(val);}
else{val=decodeURIComponent(val);}
ret[a1[0]]=val;}}
return ret;}
self.tobool=tobool;function tobool(v)
{if(typeof v==="string")
return v!==""&&v!=="0"&&v.toLowerCase()!=="false"&&v.toLowerCase()!=="off";return!!v;}
self.reloadSite=reloadSite;function reloadSite()
{var href=location.href.replace(/#.+/,'#');location.href=href;location.reload();throw"abort";}
function setWidth_2(number)
{return number<10?("0"+number):(""+number);}
Date.prototype.format=function(fmt)
{if(fmt==null)
fmt="L";switch(fmt){case"L":fmt="yyyy-mm-dd HH:MM:SS";break;case"D":fmt="yyyy-mm-dd";break;case"T":fmt="HH:MM:SS";break;}
var year=this.getFullYear();return fmt.replace("yyyy",year).replace("yy",(""+year).substring(2)).replace("mm",setWidth_2(this.getMonth()+1)).replace("dd",setWidth_2(this.getDate())).replace("HH",setWidth_2(this.getHours())).replace("MM",setWidth_2(this.getMinutes())).replace("SS",setWidth_2(this.getSeconds()));}
Date.prototype.addDay=function(iDay)
{this.setDate(this.getDate()+iDay);return this;}
Date.prototype.addHours=function(iHours)
{this.setHours(this.getHours()+iHours);return this;}
Date.prototype.addMin=function(iMin)
{this.setMinutes(this.getMinutes()+iMin);return this;}
Date.prototype.addMonth=function(iMonth)
{this.setMonth(this.getMonth()+iMonth);return this;}
self.parseTime=parseTime;function parseTime(s)
{var a=s.split(":");var dt=new Date(0,0,1,a[0],a[1]||0,a[2]||0);if(isNaN(dt.getYear()))
return null;return dt;}
self.parseDate=parseDate;function parseDate(str)
{if(str==null)
return null;if(str instanceof Date)
return str;if(/Z$/.test(str)){return new Date(str);}
var ms=str.match(/^(\d+)(?:[-\/.](\d+)(?:[-\/.](\d+))?)?/);if(ms==null)
return null;var y,m,d;var now=new Date();if(ms[3]!==undefined){y=parseInt(ms[1]);m=parseInt(ms[2])-1;d=parseInt(ms[3]);if(y<100)
y+=2000;}
else if(ms[2]!==undefined){y=now.getFullYear();m=parseInt(ms[1])-1;d=parseInt(ms[2]);}
else{y=now.getFullYear();m=now.getMonth();d=parseInt(ms[1]);}
var h,n,s;h=0;n=0;s=0;ms=str.match(/(\d+):(\d+)(?::(\d+))?/);if(ms!=null){h=parseInt(ms[1]);n=parseInt(ms[2]);if(ms[3]!==undefined)
s=parseInt(ms[3]);}
var dt=new Date(y,m,d,h,n,s);if(isNaN(dt.getYear()))
return null;ms=str.match(/:[0-9.T]+([+-])(\d{1,4})$/);if(ms!=null){var sign=(ms[1]=="-"?-1:1);var cnt=ms[2].length;var n=parseInt(ms[2].replace(/^0+/,''));if(isNaN(n))
n=0;else if(cnt>2)
n=Math.floor(n/100);var tzOffset=sign*n*60+dt.getTimezoneOffset();if(tzOffset)
dt.addMin(-tzOffset);}
return dt;}
Date.prototype.add=function(sInterval,n)
{switch(sInterval){case'd':this.setDate(this.getDate()+n);break;case'm':this.setMonth(this.getMonth()+n);break;case'y':this.setFullYear(this.getFullYear()+n);break;case'h':this.setHours(this.getHours()+n);break;case'n':this.setMinutes(this.getMinutes()+n);break;case's':this.setSeconds(this.getSeconds()+n);break;}
return this;}
Date.prototype.diff=function(sInterval,dtEnd)
{var dtStart=this;switch(sInterval)
{case'd':return Math.round((dtEnd-dtStart)/86400000);case'm':return dtEnd.getMonth()-dtStart.getMonth()+(dtEnd.getFullYear()-dtStart.getFullYear())*12;case'y':return dtEnd.getFullYear()-dtStart.getFullYear();case's':return Math.round((dtEnd-dtStart)/1000);case'n':return Math.round((dtEnd-dtStart)/60000);case'h':return Math.round((dtEnd-dtStart)/3600000);}}
self.getTimeDiffDscr=getTimeDiffDscr;function getTimeDiffDscr(tm,tm1)
{if(!tm||!tm1)
return"";if(!(tm instanceof Date)){tm=parseDate(tm);}
if(!(tm1 instanceof Date)){tm1=parseDate(tm1);}
var diff=(tm1-tm)/1000;if(diff<60){return"刚刚";}
diff/=60;if(diff<60){return Math.floor(diff)+"分钟前";}
diff/=60;if(diff<48){return Math.floor(diff)+"小时前";}
diff/=24;if(diff<365*2)
return Math.floor(diff)+"天前";diff/=365;if(diff<10)
return Math.floor(diff)+"年前";return"很久前";}
self.setCookie=setCookie;function setCookie(name,value,days)
{if(days===undefined)
days=30;if(value==null)
{days=-1;value="";}
var exp=new Date();exp.setTime(exp.getTime()+days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString();}
self.getCookie=getCookie;function getCookie(name)
{var m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));if(m!=null){return(unescape(m[2]));}else{return null;}}
self.delCookie=delCookie;function delCookie(name)
{if(getCookie(name)!=null){setCookie(name,null,-1);}}
self.setStorage=setStorage;function setStorage(name,value,useSession)
{assert(typeof value!="object","value must be scalar!");if(window.localStorage==null)
{setCookie(name,value);return;}
if(useSession)
sessionStorage.setItem(name,value);else
localStorage.setItem(name,value);}
self.getStorage=getStorage;function getStorage(name,useSession)
{if(window.localStorage==null)
{getCookie(name);return;}
var rv;if(useSession)
rv=sessionStorage.getItem(name);else
rv=localStorage.getItem(name);if(rv==null)
return getCookie(name);return rv;}
self.delStorage=delStorage;function delStorage(name,useSession)
{if(window.localStorage==null)
{delCookie(name);return;}
if(useSession)
sessionStorage.removeItem(name);else
localStorage.removeItem(name);delCookie(name);}
self.rs2Array=rs2Array;function rs2Array(rs)
{var ret=[];var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret.push(obj);}
return ret;}
self.rs2Hash=rs2Hash;function rs2Hash(rs,key)
{var ret={};var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
ret[obj[key]]=obj;}
return ret;}
self.rs2MultiHash=rs2MultiHash;function rs2MultiHash(rs,key)
{var ret={};var colCnt=rs.h.length;for(var i=0;i<rs.d.length;++i){var obj={};var row=rs.d[i];for(var j=0;j<colCnt;++j){obj[rs.h[j]]=row[j];}
if(ret[obj[key]]===undefined)
ret[obj[key]]=[];ret[obj[key]].push(obj);}
return ret;}
self.list2varr=list2varr;function list2varr(ls,sep,sep2)
{if(sep==null)
sep=':';if(sep2==null)
sep2=',';var ret=[];$.each(ls.split(sep2),function(){if(this.length==0)
return;ret.push(this.split(sep));});return ret;}
self.intSort=intSort;function intSort(a,b)
{return parseInt(a)-parseInt(b);}
self.numberSort=numberSort;function numberSort(a,b)
{return parseFloat(a)-parseFloat(b);}
self.getAncestor=getAncestor;function getAncestor(o,fn)
{while(o){if(fn(o))
return o;o=o.parentElement;}
return o;}
self.appendParam=appendParam;function appendParam(url,param)
{if(param==null)
return url;var ret;var a=url.split("#");ret=a[0]+(url.indexOf('?')>=0?"&":"?")+param;if(a.length>1){ret+="#"+a[1];}
return ret;}
self.deleteParam=deleteParam;function deleteParam(url,paramName)
{var ret=url.replace(new RegExp('&?'+paramName+"=[^&#]+"),'');if(ret.indexOf('?&')>=0){ret=ret.replace('?&','?');}
return ret;}
self.isWeixin=isWeixin;function isWeixin()
{return/micromessenger/i.test(navigator.userAgent);}
self.isIOS=isIOS;function isIOS()
{return/iPhone|iPad/i.test(navigator.userAgent);}
self.isAndroid=isAndroid;function isAndroid()
{return/Android/i.test(navigator.userAgent);}
self.parseValue=parseValue;function parseValue(str)
{if(str==null)
return str;var val=str;if(/^-?[0-9]+$/.test(str)){val=parseInt(str);}
if(/^-?[0-9.]+$/.test(str)){val=parseFloat(str);}
return val;}
self.applyTpl=applyTpl;function applyTpl(tpl,data)
{return tpl.replace(/{(\w+)}/g,function(m0,m1){return data[m1];});}
self.delayDo=delayDo;function delayDo(fn,delayCnt)
{if(delayCnt==null)
delayCnt=3;doIt();function doIt()
{if(delayCnt==0)
{fn();return;}
--delayCnt;setTimeout(doIt);}}
function initModule()
{if(String.prototype.startsWith==null){String.prototype.startsWith=function(s){return this.substr(0,s.length)==s;}}
if(window.console===undefined){window.console={log:function(){}}}}
initModule();}
function jdModule(name,fn,overrideCtor)
{if(!window.jdModuleMap){window.jdModuleMap={};}
if(name==null){return window.jdModuleMap;}
var ret;if(fn instanceof Function){if(window.jdModuleMap[name]){fn.call(window.jdModuleMap[name]);}
else{window.jdModuleMap[name]=new fn();}
ret=window.jdModuleMap[name];if(overrideCtor)
ret.constructor=fn;}
else{ret=window.jdModuleMap[name];if(!ret){throw"load module fails: "+name;}}
return ret;}
jdModule("jdcloud.common",JdcloudCommonJq);function JdcloudCommonJq()
{var self=this;self.assert(window.jQuery,"require jquery lib.");self.getFormData=getFormData;function getFormData(jo)
{var data={};var isFormData=false;if(jo.attr("enctype")=="multipart/form-data"){isFormData=true;data=new FormData();}
var orgData=jo.data("origin_")||{};formItems(jo,function(name,content){var ji=this;var orgContent=orgData[name];if(orgContent==null)
orgContent="";if(content==null)
content="";if(content!==String(orgContent))
{if(!isFormData){data[name]=content;}
else{if(ji.is(":file")){$.each(ji.prop("files"),function(i,e){data.append(name,e);});}
else{data.append(name,content);}}}});return data;}
self.formItems=formItems;function formItems(jo,cb)
{jo.find("[name]:not([disabled])").each(function(){var name=this.name;if(!name)
return;var ji=$(this);var val;if(ji.is(":input")){if(this.type=="checkbox"&&!this.checked)
return;if(this.type=="radio"&&!this.checked)
return;val=ji.val();}
else{val=ji.html();}
if(cb.call(ji,name,val)===false)
return false;});}
self.setFormData=setFormData;function setFormData(jo,data,opt)
{var opt1=$.extend({setOrigin:false},opt);if(data==null)
data={};var jo1=jo.filter("[name]:not([noReset])");jo.find("[name]:not([noReset])").add(jo1).each(function(){var ji=$(this);var name=ji.attr("name");var content=data[name];var isInput=ji.is(":input");if(content===undefined){if(isInput){if(ji[0].tagName==="TEXTAREA")
content=ji.html();else
content=ji.attr("value");if(content===undefined)
content="";}
else{content="";}}
if(ji.is(":input")){ji.val(content);}
else{ji.html(content);}});jo.data("origin_",opt1.setOrigin?data:null);}
self.loadScript=loadScript;function loadScript(url,fnOK,options)
{if($.isPlainObject(fnOK)){options=fnOK;fnOK=null;}
if(options){var ajaxOpt=$.extend({dataType:"script",cache:true,success:fnOK,url:url,error:function(xhr,textStatus,err){console.log("*** loadScript fails for "+url);console.log(err);}},options);return jQuery.ajax(ajaxOpt);}
var dfd_=$.Deferred();var script=document.createElement('script');script.type='text/javascript';script.src=url;script.onload=function(){if(fnOK)
fnOK();dfd_.resolve();}
script.onerror=function(){dfd_.reject();console.log("*** loadScript fails for "+url);}
document.head.appendChild(script);return dfd_;}
self.setDateBox=setDateBox;function setDateBox(jo,defDateFn)
{jo.blur(function(){var dt=self.parseDate(this.value);if(dt==null){if(defDateFn)
dt=defDateFn();else
dt=new Date();}
this.value=dt.format("D");});}
self.setTimeBox=setTimeBox;function setTimeBox(jo,defTimeFn)
{jo.blur(function(){var dt=self.parseTime(this.value);if(dt==null){if(defTimeFn)
dt=defTimeFn();else
dt=new Date();}
this.value=dt.format("HH:MM");});}
self.waitFor=waitFor;function waitFor(dfd)
{if(waitFor.caller==null)
throw"waitFor MUST be called in function!";if(dfd.state()=="resolved")
return false;if(!dfd.isset_)
{var caller=waitFor.caller;var args=caller.arguments;dfd.isset_=true;dfd.then(function(){caller.apply(this,args);});}
return true;}
$.fn.jdata=function(val){if(val!=null){this.data("jdata",val);return val;}
var jd=this.data("jdata");if(jd==null)
jd=this.jdata({});return jd;}}
function JdcloudApp()
{var self=this;self.ctx=self.ctx||{};window.E_AUTHFAIL=-1;window.E_NOAUTH=2;window.E_ABORT=-100;self.evalAttr=evalAttr;function evalAttr(jo,name,ctx)
{var val=jo.attr(name);if(val){if(val[0]!='{'&&val.indexOf(":")>0){val1="({"+val+"})";}
else{val1="("+val+")";}
try{val=eval(val1);}
catch(ex){self.app_alert("属性`"+name+"'格式错误: "+val,"e");val=null;}}
return val;}
self.ctx.fixPageCss=fixPageCss;function fixPageCss(css,selector)
{var prefix=selector+" ";var level=1;var css1=css.replace(/\/\*(.|\s)*?\*\//g,'').replace(/([^{}]*)([{}])/g,function(ms,text,brace){if(brace=='}'){--level;return ms;}
if(brace=='{'&&level++!=1)
return ms;return ms.replace(/((?:^|,)\s*)([^,{}]+)/g,function(ms,ms1,sel){if(sel.startsWith(prefix)||sel[0]=='@')
return ms;return ms1+prefix+sel;});});return css1;}
self.app_abort=app_abort;function app_abort()
{throw new DirectReturn();}
window.DirectReturn=function(){}
self.setOnError=setOnError;function setOnError()
{var fn=window.onerror;window.onerror=function(msg,script,line,col,errObj){if(fn&&fn.apply(this,arguments)===true)
return true;if(errObj instanceof DirectReturn||/abort$/.test(msg)||(!script&&!line))
return true;debugger;var content=msg+" ("+script+":"+line+":"+col+")";if(errObj&&errObj.stack)
content+="\n"+errObj.stack.toString();if(self.syslog)
self.syslog("fw","ERR",content);}}
setOnError();self.m_enhanceFn={};self.enhanceWithin=enhanceWithin;function enhanceWithin(jp)
{$.each(self.m_enhanceFn,function(sel,fn){var jo=jp.find(sel);if(jp.is(sel))
jo=jo.add(jp);if(jo.size()==0)
return;jo.each(function(i,e){var je=$(e);var opt=getOptions(je);if(opt.enhanced)
return;opt.enhanced=true;fn(je);});});}
self.getOptions=getOptions;function getOptions(jo)
{var opt=jo.data("muiOptions");if(opt===undefined){opt={};jo.data("muiOptions",opt);}
return opt;}
function getop(v)
{if(typeof(v)=="number")
return"="+v;var op="=";var is_like=false;if(v.match(/^(<>|>=?|<=?)/)){op=RegExp.$1;v=v.substr(op.length);}
else if(v.indexOf("*")>=0||v.indexOf("%")>=0){v=v.replace(/[*]/g,"%");op=" like ";}
v=$.trim(v);if(v==="null")
{if(op=="<>")
return" is not null";return" is null";}
if(v==="empty")
v="";if(v.length==0||v.match(/\D/)||v[0]=='0'){v=v.replace(/'/g,"\\'");return op+"'"+v+"'";}
return op+v;}
self.getQueryCond=getQueryCond;function getQueryCond(kvList)
{var condArr=[];if($.isPlainObject(kvList)){$.each(kvList,handleOne);}
else if($.isArray(kvList)){$.each(kvList,function(i,e){handleOne(e[0],e[1]);});}
function handleOne(k,v){if(v==null||v==="")
return;var arr=v.split(/\s+(and|or)\s+/i);var str='';var bracket=false;$.each(arr,function(i,v1){if((i%2)==1){str+=' '+v1.toUpperCase()+' ';bracket=true;return;}
str+=k+getop(v1);});if(bracket)
str='('+str+')';condArr.push(str);}
return condArr.join(' AND ');}
self.getQueryParam=getQueryParam;function getQueryParam(kvList)
{return{cond:getQueryCond(kvList)};}}
function JdcloudCall()
{var self=this;var mCommon=jdModule("jdcloud.common");self.lastError=null;var m_tmBusy;var m_manualBusy=0;var m_appVer;self.disableBatch=false;var m_curBatch=null;self.m_curBatch=m_curBatch;self.mockData={};var ajaxOpt={beforeSend:function(xhr){this.xhr_=xhr;},dataFilter:function(data,type){if(this.jdFilter!==false&&(type=="json"||type=="text")){rv=defDataProc.call(this,data);if(rv!=null)
return rv;--$.active;self.app_abort();}
return data;},converters:{"text json":true},error:defAjaxErrProc};if(location.protocol=="file:"){ajaxOpt.xhrFields={withCredentials:true};}
$.ajaxSetup(ajaxOpt);self.enterWaiting=enterWaiting;function enterWaiting(ctx)
{if(self.isBusy==0){m_tmBusy=new Date();}
self.isBusy=1;if(ctx==null||ctx.isMock)
++m_manualBusy;if(!(ctx&&ctx.noLoadingImg))
{setTimeout(function(){if(self.isBusy)
self.showLoading();},200);}}
self.leaveWaiting=leaveWaiting;function leaveWaiting(ctx)
{if(ctx==null||ctx.isMock)
{if(--m_manualBusy<0)
m_manualBusy=0;}
mCommon.delayDo(function(){if(self.options.logAction&&ctx&&ctx.ac&&ctx.tv){var tv2=(new Date()-ctx.tm)-ctx.tv;ctx.tv2=tv2;console.log(ctx);}
if($.active<=0&&self.isBusy&&m_manualBusy==0){$.active=0;self.isBusy=0;var tv=new Date()-m_tmBusy;m_tmBusy=0;console.log("idle after "+tv+"ms");self.hideLoading();}});}
function defAjaxErrProc(xhr,textStatus,e)
{var ctx=this.ctx_||{};ctx.status=xhr.status;ctx.statusText=xhr.statusText;if(xhr.status==0){self.app_alert("连不上服务器了，是不是网络连接不给力？","e");}
else if(this.handleHttpError){var data=xhr.responseText;var rv=defDataProc.call(this,data);if(rv!=null)
this.success&&this.success(rv);return;}
else{self.app_alert("操作失败: 服务器错误. status="+xhr.status+"-"+xhr.statusText,"e");}
leaveWaiting(ctx);}
self.defDataProc=defDataProc;function defDataProc(rv)
{var ctx=this.ctx_||{};var ext=ctx.ext;if(this.xhr_&&ext==null){var val=this.xhr_.getResponseHeader("X-Daca-Server-Rev");if(val&&g_data.serverRev!=val){if(g_data.serverRev){mCommon.reloadSite();}
console.log("Server Revision: "+val);g_data.serverRev=val;}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Test-Mode"));if(g_data.testMode!=val){g_data.testMode=val;if(g_data.testMode)
self.app_alert("测试模式!",{timeoutInterval:2000});}
val=mCommon.parseValue(this.xhr_.getResponseHeader("X-Daca-Mock-Mode"));if(g_data.mockMode!=val){g_data.mockMode=val;if(g_data.mockMode)
self.app_alert("模拟模式!",{timeoutInterval:2000});}}
try{if(rv!==""&&typeof(rv)=="string")
rv=$.parseJSON(rv);}
catch(e)
{leaveWaiting(ctx);self.app_alert("服务器数据错误。");return;}
if(ctx.tm){ctx.tv=new Date()-ctx.tm;}
ctx.ret=rv;leaveWaiting(ctx);if(ext){var filter=self.callSvrExt[ext]&&self.callSvrExt[ext].dataFilter;if(filter){var ret=filter.call(this,rv);if(ret==null||ret===false)
self.lastError=ctx;return ret;}}
if(rv&&$.isArray(rv)&&rv.length>=2&&typeof rv[0]=="number"){if(rv[0]==0)
return rv[1];if(this.noex)
{this.lastError=rv;self.lastError=ctx;return false;}
if(rv[0]==E_NOAUTH){if(self.tryAutoLogin()){$.ajax(this);}
return;}
else if(rv[0]==E_AUTHFAIL){var errmsg=rv[1]||"验证失败，请检查输入是否正确!";self.app_alert(errmsg,"e");return;}
else if(rv[0]==E_ABORT){console.log("!!! abort call");return;}
logError();self.app_alert("操作失败："+rv[1],"e");}
else{logError();self.app_alert("服务器通讯协议异常!","e");}
function logError()
{self.lastError=ctx;console.log("failed call");console.log(ctx);}}
self.getBaseUrl=getBaseUrl;function getBaseUrl()
{return self.options.serverUrl.replace(/\/[^\/]+$/,'/');}
self.makeUrl=makeUrl;function makeUrl(action,params)
{var ext;if($.isArray(action)){if(window.MUI){ext=action[1];action=action[0];}
else{ext="default";action=action[0]+"."+action[1];}}
else{var m=action.match(/^(\w+):(\w.*)/);if(m){ext=m[1];action=m[2];}
else{ext="default";}}
if(action.makeUrl||/^http/.test(action)){if(params==null)
return action;var url=mCommon.appendParam(action,$.param(params));return makeUrlObj(url);}
if(params==null)
params={};var url;var fnMakeUrl=self.callSvrExt[ext]&&self.callSvrExt[ext].makeUrl;if(fnMakeUrl){url=fnMakeUrl(action,params);}
else if(action.indexOf(".php")<0)
{var opt=self.options;var usePathInfo=!opt.serverUrlAc;if(usePathInfo){if(opt.serverUrl.slice(-1)=='/')
url=opt.serverUrl+action;else
url=opt.serverUrl+"/"+action;}
else{url=opt.serverUrl;params[opt.serverUrlAc]=action;}}
else{if(location.protocol=="file:"){url=getBaseUrl()+action;}
else
url=action;}
if(window.g_cordova){if(m_appVer===undefined)
{var platform="n";if(mCommon.isAndroid()){platform="a";}
else if(mCommon.isIOS()){platform="i";}
m_appVer=platform+"/"+g_cordova;}
params._ver=m_appVer;}
if(self.options.appName)
params._app=self.options.appName;if(g_args._debug)
params._debug=g_args._debug;var ret=mCommon.appendParam(url,$.param(params));return makeUrlObj(ret);function makeUrlObj(url)
{var o=new String(url);o.makeUrl=true;if(action.makeUrl){o.action=action.action;o.params=$.extend({},action.params,params);}
else{o.action=action;o.params=params;}
return o;}}
self.callSvr=callSvr;self.callSvrExt={};function callSvr(ac,params,fn,postParams,userOptions)
{if(params instanceof Function){userOptions=postParams;postParams=fn;fn=params;params=null;}
mCommon.assert(ac!=null,"*** bad param `ac`");var ext=null;var ac0=ac.action||ac;var m;if($.isArray(ac)){mCommon.assert(ac.length==2,"*** bad ac format, require [ac, ext]");ext=ac[1];if(ext!='default')
ac0=ext+':'+ac[0];else
ac0=ac[0];}
else if(m=ac.match(/^(\w+):(\w.*)/)){ext=m[1];}
else if(self.callSvrExt['default']){ext='default';}
var isSyncCall=(userOptions&&userOptions.async==false);if(m_curBatch&&!isSyncCall)
{return m_curBatch.addCall({ac:ac,get:params,post:postParams},fn,userOptions);}
var url=makeUrl(ac,params);var ctx={ac:ac0,tm:new Date()};if(userOptions&&userOptions.noLoadingImg)
ctx.noLoadingImg=1;if(ext){ctx.ext=ext;}
if(self.mockData&&self.mockData[ac0]){ctx.isMock=true;ctx.getMockData=function(){var d=self.mockData[ac0];var param1=$.extend({},url.params);var postParam1=$.extend({},postParams);if($.isFunction(d)){d=d(param1,postParam1);}
if(self.options.logAction)
console.log({ac:ac0,ret:d,params:param1,postParams:postParam1,userOptions:userOptions});return d;}}
enterWaiting(ctx);var callType="call";if(isSyncCall)
callType+="-sync";if(ctx.isMock)
callType+="-mock";var method=(postParams==null?'GET':'POST');var opt={dataType:'text',url:url,data:postParams,type:method,success:fn,ctx_:ctx};if(ext){opt.xhrFields={withCredentials:true};}
if(window.FormData&&postParams instanceof FormData){opt.processData=false;opt.contentType=false;}
$.extend(opt,userOptions);if(ext&&self.callSvrExt[ext].beforeSend){self.callSvrExt[ext].beforeSend(opt);}
console.log(callType+": "+opt.type+" "+ac0);if(ctx.isMock)
return callSvrMock(opt,isSyncCall);return $.ajax(opt);}
function callSvrMock(opt,isSyncCall)
{var dfd_=$.Deferred();var opt_=opt;if(isSyncCall){callSvrMock1();}
else{setTimeout(callSvrMock1,self.options.mockDelay);}
return dfd_;function callSvrMock1()
{var data=opt_.ctx_.getMockData();if(typeof(data)!="string")
data=JSON.stringify(data);var rv=defDataProc.call(opt_,data);if(rv!=null)
{opt_.success&&opt_.success(rv);dfd_.resolve(rv);return;}
self.app_abort();}}
self.callSvrSync=callSvrSync;function callSvrSync(ac,params,fn,postParams,userOptions)
{var ret;if(params instanceof Function){userOptions=postParams;postParams=fn;fn=params;params=null;}
userOptions=$.extend({async:false},userOptions);var dfd=callSvr(ac,params,fn,postParams,userOptions);dfd.then(function(data){ret=data;});return ret;}
self.setupCallSvrViaForm=setupCallSvrViaForm;function setupCallSvrViaForm($form,$iframe,url,fn,callOpt)
{$form.attr("action",url);$iframe.on("load",function(){var data=this.contentDocument.body.innerText;if(data=="")
return;var rv=defDataProc.call(callOpt,data);if(rv==null)
self.app_abort();fn(rv);});}
self.batchCall=batchCall;function batchCall(opt)
{mCommon.assert(m_curBatch==null,"*** multiple batch call!");this.opt_=opt;this.calls_=[];this.callOpts_=[];if(!self.disableBatch)
m_curBatch=this;}
batchCall.prototype={addCall:function(call0,fn,opt0){var call=$.extend({},call0);var opt=$.extend({},opt0);if(opt.ref){call.ref=opt.ref;}
this.calls_.push(call);var callOpt={fn:fn,opt:opt,dfd:$.Deferred()};this.callOpts_.push(callOpt);return callOpt.dfd;},deferred:function(){return this.dfd_;},commit:function(){if(m_curBatch==null)
return;m_curBatch=null;if(this.calls_.length<=1){console.log("!!! warning: batch has "+this.calls_.length+" calls!");}
var batch_=this;var postData=JSON.stringify(this.calls_);callSvr("batch",this.opt_,api_batch,postData,{contentType:"application/json"});function api_batch(data)
{var ajaxCtx_=this;$.each(data,function(i,e){var callOpt=batch_.callOpts_[i];var extendCtx=false;if(callOpt.opt&&!$.isEmptyObject(callOpt.opt)){extendCtx=true;$.extend(ajaxCtx_,callOpt.opt);}
var data1=defDataProc.call(ajaxCtx_,e);if(data1!=null){if(callOpt.fn){callOpt.fn.call(ajaxCtx_,data1);}
callOpt.dfd.resolve(data1);}
if(extendCtx){$.each(Object.keys(callOpt.opt),function(){ajaxCtx_[this]=null;});}});}},cancel:function(){m_curBatch=null;}}
self.useBatchCall=useBatchCall;function useBatchCall(opt,tv)
{if(self.disableBatch)
return;if(m_curBatch!=null)
return;tv=tv||0;var batch=new self.batchCall(opt);setTimeout(function(){batch.commit();},tv);}}
function JdcloudMuiPage()
{var self=this;var mCommon=jdModule("jdcloud.common");self.activePage=null;self.prevPageId=null;self.container=null;self.showFirstPage=true;var m_jstash;var m_jLoader;var m_isback=null;var m_toPageId=null;var m_lastPageRef=null;var m_curState=null;var m_pageUrlMap=null;var m_fn_history_go=history.go;var m_appId=Math.ceil(Math.random()*10000);function PageStack()
{this.stack_=[];this.sp_=-1;this.nextId_=1;}
PageStack.prototype={push:function(state){if(this.sp_<this.stack_.length-1){this.stack_.splice(this.sp_+1);}
state.id=this.nextId_;++this.nextId_;this.stack_.push(state);++this.sp_;},pop:function(n){if(n===0){var firstFound=false;for(var i=0;i<this.sp_;++i){if(!firstFound){if(!this.stack_[i].isPoped)
firstFound=true;continue;}
this.stack_[i].isPoped=true;}
return;}
if(n==null||n<0)
n=1;if(n>this.sp_){n=this.sp_+1;}
for(var i=0;i<n;++i){this.stack_[this.sp_-i].isPoped=true;}},go:function(n){if(n==0)
return 0;var curState=this.stack_[this.sp_];do{var sp=this.sp_+n;if(sp<0||sp>=this.stack_.length)
return 0;if(!this.stack_[sp].isPoped&&this.stack_[sp].pageRef!=curState.pageRef)
break;if(n<0){--n;}
else{++n;}}while(1);this.sp_=sp;return n;},findCurrentState:function(){var found=false;var sp=this.sp_;var state=m_curState;for(var i=this.stack_.length-1;i>=0;--i){if(state.id==this.stack_[i].id)
{sp=i;found=true;break;}}
if(!found)
throw"history not found";return sp-this.sp_;},walk:function(fn){for(var i=this.sp_;i>=0;--i){var state=this.stack_[i];if(!state.isPoped&&fn(state)===false)
break;}}};function getHash()
{if(m_curState)
return m_curState.pageRef;if(location.hash=="")
return self.options.homePage;return location.hash;}
function setHash(pageRef,url)
{var pi=getPageInfo(pageRef);if(m_pageUrlMap==null){m_pageUrlMap={};url=location.search;}
if(url){m_pageUrlMap[pageRef]=url;}
else{url=m_pageUrlMap[pageRef];}
if(self.options.showHash){if(url==null){url=pi.pageRef;}
else if(url[0]=="?"){url=url+pi.pageRef;}}
else{if(url==null){url=pi.pageFile;}
else if(url[0]=="?"){url=pi.pageFile+url;}}
if(m_curState==null||m_curState.pageRef!=pi.pageRef)
{var newState={pageRef:pi.pageRef,appId:m_appId,url:url};self.m_pageStack.push(newState);if(m_curState!=null)
history.pushState(newState,null,url);else
history.replaceState(newState,null,url);m_curState=newState;}
else if(m_curState.url!=url){history.replaceState(m_curState,null,url);m_curState.url=url;}
return pi;}
self.setUrl=setUrl;function setUrl(url)
{if(m_curState==null)
{if(url.indexOf("#")<0&&location.hash)
url+=location.hash;history.replaceState(null,null,url);return;}
setHash(m_curState.pageRef,url);}
self.deleteUrlParam=deleteUrlParam;function deleteUrlParam(param)
{delete g_args[param];var search=mCommon.deleteParam(location.search,param);MUI.setUrl(search);}
self.setUrlParam=setUrlParam;function setUrlParam(param,val)
{var search=location.search;if(search.indexOf(param+"=")>=0){search=mCommon.deleteParam(search,param);}
search=mCommon.appendParam(search,param+"="+val);if(search.indexOf('?&')>=0){search=search.replace('?&','?');}
MUI.setUrl(search);}
function callInitfn(jo,paramArr)
{var ret=jo.data("mui.init");if(ret!==undefined)
return ret;var initfn=self.evalAttr(jo,"mui-initfn");if(initfn==null)
return;if(initfn&&$.isFunction(initfn))
{ret=initfn.apply(jo,paramArr)||true;}
jo.data("mui.init",ret);return ret;}
function handlePageStack(pageRef)
{if(m_isback!==null)
return;var n=self.m_pageStack.findCurrentState();var n1=self.m_pageStack.go(n);if(n!=n1){setTimeout(function(){m_fn_history_go.call(window.history,n1-n);});return false;}
m_isback=n<0;}
function initPageStack()
{history.back=function(){return history.go(-1);};history.forward=function(){return history.go(1);};history.go=function(n){var n=self.m_pageStack.go(n);if(n==0)
return false;m_isback=n<0;return m_fn_history_go.call(this,n);};if('ontouchstart'in window&&$.fn.swipe){function swipeH(ev,direction,distance,duration,fingerCnt,fingerData,currentDirection){var o=ev.target;while(o){if($(o).attr('mui-swipenav')==='no')
return;o=o.parentElement;}
if(direction=='right')
{history.back();}
else if(direction=='left')
{history.forward();}}
$(document).swipe({excludedElements:"input,select,textarea,.noSwipe",swipeLeft:swipeH,swipeRight:swipeH,threshold:100,});}}
initPageStack();function getPageInfo(pageRef)
{if(pageRef=="#"||pageRef==""||pageRef==null)
pageRef=self.options.homePage;var pageId=pageRef[0]=='#'?pageRef.substr(1):pageRef;var ret={pageId:pageId,pageRef:pageRef};var p=pageId.lastIndexOf(".");if(p==-1){p=pageId.lastIndexOf('-');if(p!=-1){var plugin=pageId.substr(0,p);var pageId2=pageId.substr(p+1);if(Plugins.exists(plugin)){ret.pageFile=self.options.pluginFolder+'/'+plugin+'/m2/page/'+pageId2+'.html';}}
ret.templateRef="#tpl_"+pageId;}
else{ret.pageFile=pageId;ret.pageId=pageId.match(/[^.\/]+(?=\.)/)[0];}
if(ret.pageFile==null)
ret.pageFile=self.options.pageFolder+'/'+pageId.replace(/-/g,'/')+".html";return ret;}
self.showPage=showPage;function showPage(pageRef,opt)
{if(self.container==null)
return;if(pageRef==null)
pageRef=getHash();else if(pageRef=="#")
pageRef=self.options.homePage;else if(pageRef[0]!="#")
pageRef="#"+pageRef;if(m_lastPageRef==pageRef)
{m_isback=null;return;}
if(m_curState==null||m_curState.appId!=m_appId){m_isback=false;}
var showPageOpt_=$.extend({ani:self.options.ani},opt);var ret=handlePageStack(pageRef);if(ret===false)
return;m_lastPageRef=pageRef;var pi=setHash(pageRef,showPageOpt_.url);var pageId=pi.pageId;m_toPageId=pageId;var jpage=self.container.find("#"+pageId+".mui-page");if(jpage.size()>0)
{changePage(jpage);return;}
var jtpl=pi.templateRef?$(pi.templateRef):null;if(jtpl&&jtpl.size()>0){var html=jtpl.html();if(jtpl[0].tagName=='SCRIPT'){html=html.replace(/__script__/g,'script');}
setTimeout(function(){loadPage(html,pageId);});}
else{self.enterWaiting();var m=pi.pageFile.match(/(.+)\//);var path=m?m[1]:"";$.ajax(pi.pageFile,{error:null}).then(function(html){loadPage(html,pageId,path);}).fail(function(){self.leaveWaiting();self.app_alert("找不到页面: "+pageId,"e");history.back();return false;});}
function loadPage(html,pageId,path)
{if(m_jstash==null){m_jstash=$("<div id='muiStash' style='display:none'></div>").appendTo(self.container);}
var jpage=$(html).filter("div");if(jpage.size()>1||jpage.size()==0){console.log("!!! Warning: bad format for page '"+pageId+"'. Element count = "+jpage.size());jpage=jpage.filter(":first");}
jpage.find("style:not([mui-nofix])").each(function(){$(this).html(self.ctx.fixPageCss($(this).html(),"#"+pageId));});jpage.find("style").attr("mui-origin",pageId).appendTo(document.head);jpage.attr("id",pageId).addClass("mui-page").hide().appendTo(self.container);var val=jpage.attr("mui-script");if(val!=null){if(path==null)
path=self.options.pageFolder;if(path!="")
val=path+"/"+val;var dfd=mCommon.loadScript(val,initPage);dfd.fail(function(){self.app_alert("加载失败: "+val);self.leaveWaiting();history.back();});}
else{initPage();}
function initPage()
{var dep=self.evalAttr(jpage,"mui-deferred");if(dep){self.assert(dep.then,"*** mui-deferred attribute DOES NOT return a deferred object");jpage.removeAttr("mui-deferred");dep.then(initPage);return;}
var fname=jpage.attr("mui-initfn");if(fname&&window[fname]==null){var failTry_=jpage.data("failTry_");var dt=new Date();if(failTry_==null){self.app_alert("逻辑页错误，或页面被移动运营商劫持! 正在重试...");failTry_=dt;jpage.data("failTry_",failTry_);}
if(dt-failTry_<10000)
setTimeout(initPage,200);else
console.log("逻辑页加载失败: "+jpage.attr("id"));return;}
self.enhanceWithin(jpage);var ret=callInitfn(jpage);if(ret instanceof jQuery)
jpage=ret;jpage.trigger("pagecreate");changePage(jpage);self.leaveWaiting();}}
function changePage(jpage)
{if(self.activePage&&self.activePage[0]===jpage[0])
return;var oldPage=self.activePage;if(oldPage){self.prevPageId=oldPage.attr("id");}
var toPageId=jpage.attr("id");jpage.trigger("pagebeforeshow",[showPageOpt_]);if(toPageId!=m_toPageId)
{var pageRef="#"+toPageId;self.m_pageStack.walk(function(state){if(state.pageRef==pageRef){state.isPoped=true;return false;}});return;}
var enableAni=showPageOpt_.ani!=='none';var slideInClass=m_isback?"slideIn1":"slideIn";m_isback=null;self.container.show();jpage.css("z-index",1).show();if(oldPage)
oldPage.css("z-index","-1");if(enableAni){jpage.addClass(slideInClass);jpage.one("animationend",onAnimationEnd).one("webkitAnimationEnd",onAnimationEnd);}
self.activePage=jpage;fixPageSize();var title=jpage.find(".hd h1, .hd h2").filter(":first").text()||self.title||jpage.attr("id");setDocTitle(title);if(!enableAni){onAnimationEnd();}
function onAnimationEnd()
{if(enableAni){jpage.removeClass(slideInClass);}
if(toPageId!=m_toPageId)
return;jpage.trigger("pageshow",[showPageOpt_]);if(oldPage){oldPage.trigger("pagehide");oldPage.hide();}}}}
self.setDocTitle=setDocTitle;function setDocTitle(newTitle)
{document.title=newTitle;if(mCommon.isIOS()&&mCommon.isWeixin()){document.title=newTitle;var $iframe=$('<iframe src="/favicon.ico"></iframe>');$iframe.one('load',function(){setTimeout(function(){$iframe.remove();},0);}).appendTo(self.container);}}
self.unloadPage=unloadPage;function unloadPage(pageRef)
{var jo=null;var pageId=null;if(pageRef==null){jo=self.activePage;pageId=jo.attr("id");pageRef="#"+pageId;}
else{if(pageRef[0]=="#"){pageId=pageRef.substr(1);}
else{pageId=pageRef;pageRef="#"+pageId;}
jo=$(pageRef);}
if(jo.find("#footer").size()>0)
jo.find("#footer").appendTo(m_jstash);jo.remove();$("style[mui-origin="+pageId+"]").remove();}
self.reloadPage=reloadPage;function reloadPage(pageRef,opt)
{if(pageRef==null)
pageRef="#"+self.activePage.attr("id");unloadPage(pageRef);m_lastPageRef=null;showPage(pageRef,opt);}
self.m_pageStack=new PageStack();self.popPageStack=popPageStack;function popPageStack(n)
{self.m_pageStack.pop(n);}
$(window).on('popstate',function(ev){m_curState=ev.originalEvent.state;if(m_curState)
showPage();});$(window).on('orientationchange',fixPageSize);$(window).on('resize',fixPageSize);function fixPageSize()
{if(self.activePage){var jpage=self.activePage;var H=self.container.height();var jo,hd,ft;jo=jpage.find(">.hd");hd=(jo.size()>0&&jo.css("display")!="none")?jo.height():0;jo=jpage.find(">.ft");ft=(jo.size()>0&&jo.css("display")!="none")?jo.height():0;jpage.height(H);jpage.find(">.bd").css({top:hd,bottom:ft});}}
self.getToPageId=getToPageId;function getToPageId()
{return m_toPageId;}
self.m_enhanceFn["#footer"]=enhanceFooter;self.m_enhanceFn[".mui-navbar"]=enhanceNavbar;function activateElem(jo)
{if(jo.hasClass("active"))
return;var jo1=jo.parent().find(">*.active").removeClass("active");jo.addClass("active");handleLinkto(jo,true);handleLinkto(jo1,false);function handleLinkto(jo,active)
{var ref=jo.attr("mui-linkto");if(ref){var jlink=jo.closest(".mui-page").find(ref);jlink.toggle(active);jlink.toggleClass("active",active);}}}
function enhanceNavbar(jo)
{if(jo.hasClass("noactive"))
return;var ja=jo.find(">.active");if(ja.size()==0){ja=jo.find(">:first").addClass("active");}
else if(ja.size()>1){ja.filter(":not(:first)").removeClass("active");ja=ja.filter(":first");}
var jpage_=null;jo.find(">*").on('click',function(){activateElem($(this));}).each(function(){var ref=$(this).attr("mui-linkto");if(ref){if(jpage_==null)
jpage=jo.closest(".mui-page");var active=$(this).hasClass("active");var jlink=jpage.find(ref);jlink.toggle(active);jlink.toggleClass("active",active);}});}
function enhanceFooter(jfooter)
{enhanceNavbar(jfooter);jfooter.addClass("ft").addClass("mui-navbar");var jnavs=jfooter.find(">a");var id2nav={};jnavs.each(function(i,e){var m=e.href.match(/#(\w+)/);if(m){id2nav[m[1]]=e;}});$(document).on("pagebeforeshow",function(ev){var jpage=$(ev.target);var pageId=jpage.attr("id");if(m_toPageId!=pageId)
return;var e=id2nav[pageId];if(e===undefined)
{if(jfooter.parent()[0]!==m_jstash[0])
jfooter.appendTo(m_jstash);return;}
jfooter.appendTo(jpage);activateElem($(e));});}
self.m_enhanceFn[".mui-dialog, .mui-menu"]=enhanceDialog;function enhanceDialog(jo)
{jo.wrap("<div class=\"mui-mask\" style=\"display:none\"></div>");var isMenu=jo[0].classList.contains("mui-menu");jo.parent().click(function(ev){if(!isMenu&&this!==ev.target)
return;closeDialog(jo);});}
self.showDialog=showDialog;function showDialog(jdlg)
{if(jdlg.constructor===String){jdlg=MUI.activePage.find(jdlg);}
var opt=self.getOptions(jdlg);if(opt.initfn){opt.onBeforeShow=opt.initfn.call(jdlg);opt.initfn=null;}
if(opt.onBeforeShow)
opt.onBeforeShow.call(jdlg);jdlg.show();jdlg.parent().show();self.container.show();}
self.closeDialog=closeDialog;function closeDialog(jdlg,remove)
{if(remove){jdlg.parent().remove();return;}
jdlg.parent().hide();}
self.setupDialog=setupDialog;function setupDialog(jdlg,initfn)
{self.getOptions(jdlg).initfn=initfn;}
window.app_alert=self.app_alert=app_alert;function app_alert(msg)
{var type="i";var fn=null;var alertOpt={};for(var i=1;i<arguments.length;++i){var arg=arguments[i];if($.isFunction(arg)){fn=arg;}
else if($.isPlainObject(arg)){alertOpt=arg;}
else if(typeof(arg)==="string"){type=arg;}}
var s={i:"提示",w:"警告",e:"出错了",q:"确认",p:"输入"}[type];var jdlg=self.container.find("#muiAlert");if(jdlg.size()==0){var html=''+'<div id="muiAlert" class="mui-dialog">'+' <h3 class="hd p-title"></h3>'+' <div class="sp p-msg"></div>'+' <input type="text" id="txtInput" style="border:1px solid #bbb; line-height:1.5">'+' <div class="sp nowrap">'+'  <a href="javascript:;" id="btnOK" class="mui-btn primary">确定</a>'+'  <a href="javascript:;" id="btnCancel" class="mui-btn">取消</a>'+' </div>'+'</div>'
jdlg=$(html);self.enhanceWithin(jdlg);jdlg.parent().appendTo(self.container);}
var isClone=false;if(jdlg.parent().is(":visible")){var jo=jdlg.parent().clone().appendTo(self.container);jdlg=jo.find(".mui-dialog");isClone=true;}
var opt=self.getOptions(jdlg);if(opt.type==null){jdlg.find("#btnOK, #btnCancel").click(app_alert_click);jdlg.keydown(app_alert_keydown);}
opt.type=type;opt.fn=fn;opt.alertOpt=alertOpt;opt.isClone=isClone;jdlg.find("#btnCancel").toggle(type=="q"||type=="p");var jtxt=jdlg.find("#txtInput");jtxt.toggle(type=="p");if(type=="p"){jtxt.val(alertOpt.defValue);setTimeout(function(){jtxt.focus();});}
jdlg.find(".p-title").html(s);jdlg.find(".p-msg").html(msg);self.showDialog(jdlg);if(alertOpt.timeoutInterval!=null){opt.timer=setTimeout(function(){jdlg.find("#btnOK").click();},alertOpt.timeoutInterval);}}
function app_alert_click(ev)
{var jdlg=$(this).closest("#muiAlert");mCommon.assert(jdlg.size()>0);var opt=self.getOptions(jdlg);if(opt.timer){clearInterval(opt.timer);opt.timer=null;}
var btnId=this.id;if(opt.fn&&btnId=="btnOK"){if(opt.type=="p"){var text=jdlg.find("#txtInput").val();if(text!=""){opt.fn(text);}
else if(opt.alertOpt.onCancel){opt.alertOpt.onCancel();}}
else{opt.fn();}}
else if(btnId=="btnCancel"&&opt.alertOpt.onCancel){opt.alertOpt.onCancel();}
self.closeDialog(jdlg,opt.isClone);}
function app_alert_keydown(ev)
{if(ev.keyCode==13){return $(this).find("#btnOK").click();}
else if(ev.keyCode==27){return $(this).find("#btnCancel").click();}}
self.showLoading=showLoading;function showLoading()
{if(m_jLoader==null){m_jLoader=$("<div class='mui-loader'></div>");}
m_jLoader.appendTo(document.body);}
self.hideLoading=hideLoading;function hideLoading()
{if(m_jLoader)
m_jLoader.remove();}
self.m_enhanceFn["a[href^=#]"]=enhanceAnchor;function enhanceAnchor(jo)
{if(jo.attr("onclick"))
return;jo.click(function(ev){ev.preventDefault();var href=jo.attr("href");if(href.substr(1,3)=="dlg"){var jdlg=self.activePage.find(href);self.showDialog(jdlg);return;}
var opt=self.evalAttr(jo,"mui-opt");self.showPage(href,opt);});}
function main()
{self.title=document.title;self.container=$(".mui-container");if(self.container.size()==0)
self.container=$(document.body);self.enhanceWithin(self.container);self.container.trigger("muiInit");if(self.showFirstPage)
showPage();}
$(main);}
jdModule("jdcloud.mui",JdcloudMui);function JdcloudMui()
{var self=this;var mCommon=jdModule("jdcloud.common");JdcloudApp.call(self);JdcloudCall.call(self);JdcloudMuiPage.call(self);self.isBusy=false;window.g_args={};window.g_cordova=0;window.g_data={};var m_opt=self.options={appName:"user",loginPage:"#login",homePage:"#home",pageFolder:"page",serverUrl:"./",logAction:false,PAGE_SZ:20,manualSplash:false,mockDelay:50,pluginFolder:"../plugin",showHash:($("base").attr("mui-showHash")!="no"),};var m_onLoginOK;var m_allowedEntries;function document_pageCreate(ev)
{var jpage=$(ev.target);var jhdr=jpage.find("> .hd");jhdr.click(function(ev){if($(ev.target).hasClass("hd")||ev.target.tagName=="H1"||ev.target.tagName=="H2")
switchTestMode(this);});}
$(document).on("pagecreate",document_pageCreate);function handleIos7Statusbar()
{if(g_cordova){var ms=navigator.userAgent.match(/(iPad.*|iPhone.*|iPod.*);.*CPU.*OS (\d+)_\d/i);if(ms){var ver=ms[2];if(ver>=7){self.container.css("margin-top","20px");}}}}
self.setFormSubmit=setFormSubmit;function setFormSubmit(jf,fn,opt)
{opt=opt||{};jf.submit(function(ev){ev.preventDefault();var queryParam={ac:jf.attr("action")};if(opt.validate){if(false===opt.validate(jf,queryParam))
return false;}
var postParam=mCommon.getFormData(jf);if(!$.isEmptyObject(postParam)){var ac=queryParam.ac;delete queryParam.ac;self.callSvr(ac,queryParam,fn,postParam,{userPost:postParam});}
else if(opt.onNoAction){opt.onNoAction(jf);}
return false;});}
$(document).on("deviceready",function(){var homePageId=m_opt.homePage.substr(1);$(document).on("backbutton",function(){if(self.activePage.attr("id")==homePageId){self.app_alert("退出应用?",'q',function(){navigator.app.exitApp();});return;}
history.back();});$(document).on("menubutton",function(){});if(!m_opt.manualSplash&&navigator.splashscreen&&navigator.splashscreen.hide)
{$(function(){setTimeout(function(){navigator.splashscreen.hide();},500);});}});function isLoginPage(pageRef)
{if(/^\w/.test(pageRef)){pageRef="#"+pageRef;}
if(pageRef.indexOf(m_opt.loginPage)!=0)
return false;return true;}
function getPageRef(page)
{var pageRef=page;if(page==null){if(self.activePage){pageRef="#"+self.activePage.attr("id");}
else{pageRef=location.hash||m_opt.homePage;}}
else if(page instanceof jQuery){pageRef="#"+page.attr("id");}
else if(page==="#"||page===""){pageRef=m_opt.homePage;}
return pageRef;}
self.showLogin=showLogin;function showLogin(page)
{var pageRef=getPageRef(page);m_onLoginOK=function(){if(MUI.activePage&&isLoginPage(MUI.getToPageId()))
MUI.showPage(pageRef);}
MUI.showPage(m_opt.loginPage);}
self.showHome=showHome;function showHome()
{self.showPage(m_opt.homePage);}
self.logout=logout;function logout(dontReload)
{deleteLoginToken();g_data.userInfo=null;self.callSvr("logout",function(){if(!dontReload)
mCommon.reloadSite();});}
self.validateEntry=validateEntry;function validateEntry(allowedEntries)
{if(allowedEntries==null)
return;m_allowedEntries=allowedEntries;if((location.hash&&location.hash!="#"&&allowedEntries.indexOf(location.hash)<0)){location.href=location.pathname+location.search;self.app_abort();}}
function parseArgs()
{if(location.search)
g_args=mCommon.parseQuery(location.search.substr(1));if(g_args.cordova||mCommon.getStorage("cordova")){if(g_args.cordova===0){mCommon.delStorage("cordova");}
else{g_cordova=parseInt(g_args.cordova||mCommon.getStorage("cordova"));g_args.cordova=g_cordova;mCommon.setStorage("cordova",g_cordova);$(function(){var path='./';if(mCommon.isIOS()){mCommon.loadScript(path+"cordova-ios/cordova.js?__HASH__,..");}
else{mCommon.loadScript(path+"cordova/cordova.js?__HASH__,..");}});}}}
parseArgs();function tokenName()
{var name="token";if(m_opt.appName)
name+="_"+m_opt.appName;return name;}
function saveLoginToken(data)
{if(data._token)
{mCommon.setStorage(tokenName(),data._token);}}
function loadLoginToken()
{return mCommon.getStorage(tokenName());}
function deleteLoginToken()
{mCommon.delStorage(tokenName());}
self.tryAutoLogin=tryAutoLogin;function tryAutoLogin(onHandleLogin,reuseCmd,allowNoLogin)
{var ok=false;var ajaxOpt={async:false,noex:true};function handleAutoLogin(data)
{if(data===false)
return;g_data.userInfo=data;if(onHandleLogin)
onHandleLogin.call(this,data);ok=true;}
if(reuseCmd!=null){self.callSvr(reuseCmd,handleAutoLogin,null,ajaxOpt);}
if(ok)
return ok;var token=loadLoginToken();if(token!=null)
{var param={wantAll:1};var postData={token:token};self.callSvr("login",param,handleAutoLogin,postData,ajaxOpt);}
if(ok)
return ok;if(!allowNoLogin)
{self.showFirstPage=false;showLogin();}
return ok;}
self.handleLogin=handleLogin;function handleLogin(data)
{saveLoginToken(data);if(data.id==null)
return;g_data.userInfo=data;var popN=0;self.m_pageStack.walk(function(state){if(!isLoginPage(state.pageRef))
return false;++popN;});if(popN>0)
self.popPageStack(popN);if(m_onLoginOK){var fn=m_onLoginOK;m_onLoginOK=null;setTimeout(fn);}}
self.initClient=initClient;var plugins_={};function initClient(param)
{self.callSvrSync('initClient',param,function(data){g_data.initClient=data;plugins_=data.plugins||{};$.each(plugins_,function(k,e){if(e.js){var js=m_opt.pluginFolder+'/'+k+'/'+e.js;mCommon.loadScript(js,{async:true});}});});}
window.Plugins={exists:function(pname){return plugins_[pname]!==undefined;},list:function(){return plugins_;}};function switchTestMode(obj)
{var INTERVAL=4;var MAX_CNT=5;var f=switchTestMode;var tm=new Date();if(f.cnt==null||f.lastTm==null||tm-f.lastTm>INTERVAL*1000||f.lastObj!=obj)
{f.cnt=0;f.lastTm=tm;f.lastObj=obj;}
if(++f.cnt>=MAX_CNT){f.cnt=0;f.lastTm=tm;var url=prompt("切换URL?",location.href);if(url==null||url===""||url==location.href)
return;if(url[0]=="/"){url="http://"+url;}
location.href=url;self.app_abort();}}
function main()
{var jc=self.container;if(mCommon.isIOS()){jc.addClass("mui-ios");}
else if(mCommon.isAndroid()){jc.addClass("mui-android");}
if(g_cordova){jc.addClass("mui-cordova");}
if(mCommon.isWeixin()){jc.addClass("mui-weixin");}
console.log(jc.attr("class"));if(!m_opt.noHandleIosStatusBar)
handleIos7Statusbar();}
$(main);self.filterCordovaModule=filterCordovaModule;function filterCordovaModule(module)
{var plugins=module.exports;module.exports=[];var app=(window.g_args&&MUI.options.appName)||'user';var ver=(window.g_args&&g_args.cordova)||1;plugins.forEach(function(e){var yes=0;if(e.filter){e.filter.forEach(function(f){if(app==f[0]&&ver>=(f[1]||1)&&ver<=(f[2]||9999)){yes=1;return false;}});}
else{yes=1;}
if(yes)
module.exports.push(e);});if(plugins.metadata)
module.exports.metadata=plugins.metadata;}
var RE_CurrencyField=/(?:^(?:amount|price|total|qty)|(?:Amount|Price|Total|Qty))\d*$/;var RE_DateField=/(?:^(?:dt|tm)|(?:Dt|Tm))\d*$/;self.formatField=formatField;function formatField(obj)
{for(var k in obj){if(obj[k]==null||typeof obj[k]!=='string')
continue;if(RE_DateField.test(k))
obj[k]=mCommon.parseDate(obj[k]);else if(RE_CurrencyField.test(k))
obj[k]=parseFloat(obj[k]);}
return obj;}
window.hd_back=hd_back;function hd_back(pageRef)
{var n=0;MUI.m_pageStack.walk(function(state){if(++n>1)
return false;});if(n<=1){if(pageRef==null)
pageRef=MUI.options.homePage;if(!isLoginPage(MUI.activePage.attr("id")))
MUI.showPage(pageRef);return;}
history.back();}
self.syslog=syslog;function syslog(module,pri,content)
{if(!Plugins.exists("syslog"))
return;try{var postParam={module:module,pri:pri,content:content};self.callSvr("Syslog.add",$.noop,postParam,{noex:1,noLoadingImg:1});}catch(e){console.log(e);}}}
jdModule("jdcloud.mui",JdcloudListPage);function JdcloudListPage()
{var self=this;var mCommon=jdModule("jdcloud.common");self.initPullList=initPullList;function initPullList(container,opt)
{var opt_=$.extend({threshold:180,onHint:onHint,autoLoadMore:true,},opt);var cont_=container;var touchev_=null;var mouseMoved_=false;var SAMPLE_INTERVAL=200;var TRIGGER_AUTOLOAD=30;var lastUpdateTm_=new Date();var dy_=0;window.requestAnimationFrame=window.requestAnimationFrame||function(fn){setTimeout(fn,1000/60);};if("ontouchstart"in window){cont_.addEventListener("touchstart",touchStart);cont_.addEventListener("touchmove",touchMove);cont_.addEventListener("touchend",touchEnd);cont_.addEventListener("touchcancel",touchCancel);}
else{cont_.addEventListener("mousedown",mouseDown);}
if($(cont_).css("overflowY")=="visible"){cont_.style.overflowY="auto";}
function getPos(ev)
{var t=ev;if(ev.changedTouches){t=ev.changedTouches[0];}
return[t.pageX,t.pageY];}
var jo_;function onHint(ac,dy,threshold)
{var msg=null;if(jo_==null){jo_=$("<div class='mui-pullPrompt'></div>");}
var uptoThreshold=dy>=threshold;if(ac=="U"){msg=uptoThreshold?"<b>松开加载~~~</b>":"即将加载...";}
else if(ac=="D"){msg=uptoThreshold?"<b>松开刷新~~~</b>":"即将刷新...";}
if(opt_.onHintText){var rv=opt_.onHintText(ac,uptoThreshold);if(rv!=null)
msg=rv;}
var height=Math.min(dy,100,2.0*Math.pow(dy,0.7));if(msg==null){jo_.height(0).remove();return;}
jo_.html(msg);jo_.height(height).css("lineHeight",height+"px");if(ac=="D"){var c=cont_.getElementsByClassName("mui-pullHint")[0];if(c)
jo_.appendTo(c);else
jo_.prependTo(cont_);}
else if(ac=="U"){jo_.appendTo(cont_);}}
function updateHint(ac,dy)
{if(ac==null||dy==0||(opt_.autoLoadMore&&ac=='U')){ac=null;}
else{dy=Math.abs(dy);}
opt_.onHint.call(this,ac,dy,opt_.threshold);}
function touchStart(ev)
{if(opt_.onPull&&opt_.onPull(ev)===false){ev.cancelPull_=true;return;}
var p=getPos(ev);touchev_={ac:null,top0:cont_.scrollTop,x0:p[0],y0:p[1],dx:0,dy:0,momentum:{x0:p[0],y0:p[1],startTime:new Date()}};}
function mouseDown(ev)
{mouseMoved_=false;touchStart(ev);if(ev.cancelPull_===true)
return;window.addEventListener("mousemove",mouseMove,true);window.addEventListener("mouseup",mouseUp,true);window.addEventListener("click",click,true);}
function click(ev)
{window.removeEventListener("click",click,true);if(mouseMoved_)
{ev.stopPropagation();ev.preventDefault();}}
function mouseMove(ev)
{touchMove(ev);if(touchev_==null)
return;if(touchev_.dx!=0||touchev_.dy!=0)
mouseMoved_=true;ev.stopPropagation();ev.preventDefault();}
function mouseUp(ev)
{touchEnd(ev);window.removeEventListener("mousemove",mouseMove,true);window.removeEventListener("mouseup",mouseUp,true);ev.stopPropagation();ev.preventDefault();}
function touchMove(ev)
{if(touchev_==null)
return;var p=getPos(ev);var m=touchev_.momentum;if(m){var now=new Date();if(now-m.startTime>SAMPLE_INTERVAL){m.startTime=now;m.x0=p[0];m.y0=p[1];}}
touchev_.dx=p[0]-touchev_.x0;touchev_.dy=p[1]-touchev_.y0;dy_=touchev_.dy;if(touchev_.dy==0||Math.abs(touchev_.dx)>Math.abs(touchev_.dy)){touchCancel();return;}
cont_.scrollTop=touchev_.top0-touchev_.dy;var dy=touchev_.dy+(cont_.scrollTop-touchev_.top0);touchev_.pully=dy;if(cont_.scrollTop<=0&&dy>0){touchev_.ac="D";}
else if(dy<0&&cont_.scrollTop>=cont_.scrollHeight-cont_.clientHeight){touchev_.ac="U";}
updateHint(touchev_.ac,dy);ev.preventDefault();}
function touchCancel(ev)
{touchev_=null;updateHint(null,0);}
function momentumScroll(ev,onScrollEnd)
{if(touchev_==null||touchev_.momentum==null)
return;var m=touchev_.momentum;var dt=new Date();var duration=dt-m.startTime;if(duration>SAMPLE_INTERVAL){onScrollEnd&&onScrollEnd();return;}
var p=getPos(ev);var v0=(p[1]-m.y0)/duration;if(v0==0){onScrollEnd&&onScrollEnd();return;}
v0*=2.5;var deceleration=0.0005;window.requestAnimationFrame(moveNext);function moveNext()
{if(touchev_!=null)
return;var dt1=new Date();var t=dt1-dt;dt=dt1;var s=v0*t/2;var dir=v0<0?-1:1;v0-=deceleration*t*dir;deceleration*=1.1;var top=cont_.scrollTop;cont_.scrollTop=top-s;if(v0*dir>0&&top!=cont_.scrollTop){window.requestAnimationFrame(moveNext);}
else{onScrollEnd&&onScrollEnd();}}}
function touchEnd(ev)
{updateHint(null,0);if(touchev_==null||touchev_.ac==null||Math.abs(touchev_.pully)<opt_.threshold)
{momentumScroll(ev,onScrollEnd);touchev_=null;return;}
console.log(touchev_);doAction(touchev_.ac);dy_=0;touchev_=null;function doAction(ac)
{if(ac=="D"){console.log("refresh");opt_.onLoadItem.call(cont_,true);}
else if(ac=="U"){console.log("load more");opt_.onLoadItem.call(cont_,false);}}
function onScrollEnd()
{if(opt_.autoLoadMore&&dy_<-20){var distanceToBottom=cont_.scrollHeight-cont_.clientHeight-cont_.scrollTop;if(distanceToBottom<=TRIGGER_AUTOLOAD){doAction("U");}}
dy_=0;}}}
self.initPageList=initPageList;function initPageList(jpage,opt)
{var opt_=$.extend({},initPageList.options,opt);var jallList_=opt_.listRef instanceof jQuery?opt_.listRef:jpage.find(opt_.listRef);var jbtns_=opt_.navRef instanceof jQuery?opt_.navRef:jpage.find(opt_.navRef);var firstShow_=true;var busy_=false;if(jbtns_.hasClass("mui-navbar")){jbtns_=jbtns_.find("a");}
else{linkNavbarAndList(jbtns_,jallList_);}
if(jallList_.size()==0)
throw"bad list";init();function linkNavbarAndList(jbtns,jlsts)
{jbtns.each(function(i,e){$(e).data("linkTo",jlsts[i]);});jbtns.click(function(){jlsts.removeClass("active");var lst=$(this).data("linkTo");$(lst).addClass("active");});}
function init()
{jpage.on("pagebeforeshow",pagebeforeshow);function pagebeforeshow()
{if(opt_.pageItf&&opt_.pageItf.refresh){jallList_.data("nextkey_",null);opt_.pageItf.refresh=false;firstShow_=true;}
if(firstShow_){setTimeout(function(){showOrderList(false,false);});}}
jbtns_.click(function(ev){setTimeout(function(){showOrderList(false,true);});});if(opt_.canPullDown){var pullListOpt={onLoadItem:showOrderList,onHintText:onHintText,onPull:function(ev){var jlst=getActiveList();if(jlst.is(".mui-noPull")||(opt_.onPull&&opt_.onPull(ev,jlst)===false)){return false;}}};jallList_.parent().each(function(){var container=this;initPullList(container,pullListOpt);});}
else{jallList_.parent().scroll(function(){var container=this;if(!busy_&&container.scrollTop/(container.scrollHeight-container.clientHeight)>=0.95){console.log("load more");loadMore();}});}
if(MUI.activePage&&MUI.activePage.attr("id")==jpage.attr("id")){pagebeforeshow();}}
function getActiveList()
{if(jallList_.size()<=1)
return jallList_;var jlst=jallList_.filter(".active");if(jlst.size()==0)
jlst=jallList_.filter(":first");return jlst;}
function onHintText(ac,uptoThreshold)
{if(ac=="D"){var jlst=getActiveList();if(jlst.size()==0)
return;var tm=jlst.data("lastUpdateTm_");if(!tm)
return;var diff=mCommon.getTimeDiffDscr(tm,new Date());var str=diff+"刷新";if(uptoThreshold){msg="<b>"+str+"~~~</b>";}
else{msg=str;}
return msg;}}
function showOrderList(isRefresh,skipIfLoaded)
{var jlst=getActiveList();if(jlst.is(".mui-noPull"))
return;if(jlst.size()==0)
return;if(busy_){var tm=jlst.data("lastCallTm_");if(tm&&new Date()-tm<=5000)
{console.log('!!! ignore duplicated call');return;}}
var nextkey=jlst.data("nextkey_");if(isRefresh){nextkey=null;}
if(nextkey==null){opt_.onRemoveAll(jlst);}
else if(nextkey===-1)
return;if(skipIfLoaded&&nextkey!=null)
return;var queryParam=self.evalAttr(jlst,"data-queryParam")||{};$.each(["ac","res","cond","orderby"],function(){var val=jlst.attr("data-"+this);if(val)
queryParam[this]=val;});if(opt_.onBeforeLoad){var rv=opt_.onBeforeLoad(jlst,nextkey==null);if(rv===false)
return;}
if(opt_.onGetQueryParam){opt_.onGetQueryParam(jlst,queryParam);}
if(!queryParam[opt_.pageszName])
queryParam[opt_.pageszName]=MUI.options.PAGE_SZ;if(nextkey)
queryParam[opt_.pagekeyName]=nextkey;var loadMore_=!!nextkey;var joLoadMore_;if(loadMore_){if(joLoadMore_==null){joLoadMore_=$("<div class='mui-loadPrompt'>正在加载...</div>");}
joLoadMore_.appendTo(jlst);var cont=jlst.parent()[0];cont.scrollTop=cont.scrollHeight;}
else{jlst.data("lastUpdateTm_",new Date());}
jlst.data("lastCallTm_",new Date());busy_=true;var ac=queryParam.ac;mCommon.assert(ac!=null,"*** queryParam `ac` is not defined");delete queryParam.ac;self.callSvr(ac,queryParam,api_OrdrQuery);function api_OrdrQuery(data)
{busy_=false;firstShow_=false;if(loadMore_){joLoadMore_.remove();}
if(opt_.onGetData){var pagesz=queryParam[opt_.pageszName];var pagekey=queryParam[opt_.pagekeyName];opt_.onGetData(data,pagesz,pagekey);}
var arr=data;if($.isArray(data.h)&&$.isArray(data.d)){arr=mCommon.rs2Array(data);}
else if($.isArray(data.list)){arr=data.list;}
mCommon.assert($.isArray(arr),"*** initPageList error: no list!");var isFirstPage=(nextkey==null);var isLastPage=(data.nextkey==null);var param={arr:arr,isFirstPage:isFirstPage};$.each(arr,function(i,itemData){param.idx=i;opt_.onAddItem&&opt_.onAddItem(jlst,itemData,param);});if(!isLastPage)
jlst.data("nextkey_",data.nextkey);else{if(jlst[0].children.length==0){opt_.onNoItem&&opt_.onNoItem(jlst);}
jlst.data("nextkey_",-1);}
opt_.onLoad&&opt_.onLoad(jlst,isLastPage);}}
function refresh()
{showOrderList(true,false);}
function loadMore()
{showOrderList(false);}
function markRefresh(jlst)
{if(jlst)
jlst.data("nextkey_",null);else
jallList_.data("nextkey_",null);}
var itf={refresh:refresh,markRefresh:markRefresh,loadMore:loadMore,};return itf;}
initPageList.options={navRef:">.hd .mui-navbar",listRef:">.bd .p-list",pageszName:"pagesz",pagekeyName:"pagekey",canPullDown:true,onRemoveAll:function(jlst){jlst.empty();}};}
jdModule("jdcloud.mui",JdcloudDetailPage);function JdcloudDetailPage()
{var self=this;var mCommon=jdModule("jdcloud.common");window.FormMode={forAdd:"A",forSet:"S",forFind:"F"};function showByFormMode(jo,formMode)
{jo.find(".forSet, .forAdd").each(function(){var cls=null;if(formMode==FormMode.forSet){cls="forSet";}
else if(formMode==FormMode.forAdd){cls="forAdd";}
if(cls)
$(this).toggle($(this).hasClass(cls));});}
self.initPageDetail=initPageDetail;function initPageDetail(jpage,opt)
{var pageItf=opt.pageItf;if(!pageItf)
throw("require opt.pageItf");var jf=opt.jform||jpage.find("form:first");var obj_=jf.attr("action");if(!obj_||/\W/.test(obj_))
throw("bad object: form.action="+obj_);jpage.on("pagebeforeshow",onPageBeforeShow);MUI.setFormSubmit(jf,api_Ordr,{validate:onValidate,onNoAction:opt.onNoAction||history.back,});function onValidate(jf,queryParam)
{var ac;if(pageItf.formMode==FormMode.forAdd){ac="add";}
else if(pageItf.formMode==FormMode.forSet){ac="set";queryParam.id=pageItf.formData.id;}
queryParam.ac=obj_+"."+ac;var ret;if(opt.onValidate){ret=opt.onValidate(jf,queryParam);}
return ret;}
function api_Ordr(data)
{if(pageItf.formMode==FormMode.forAdd){MUI.popPageStack();opt.onAdd&&opt.onAdd(data);}
else if(pageItf.formMode==FormMode.forSet){var originData=jf.data("origin_");$.extend(originData,this.userPost);opt.onSet&&opt.onSet(originData);}}
function onPageBeforeShow()
{if(pageItf.formMode==FormMode.forAdd){mCommon.setFormData(jf,pageItf.formData);}
else if(pageItf.formMode==FormMode.forSet){showObject();}
else if(pageItf.formMode==FormMode.forFind){mCommon.setFormData(jf);}
showByFormMode(jpage,pageItf.formMode);}
function showObject(refresh)
{var data=pageItf.formData;if(data==null||data.id==null){console.log("!!! showObject: no obj or obj.id");return;}
var needGet=true;if(!refresh){for(var prop in data){if(prop=="id"||$.isFunction(data[prop]))
continue;needGet=false;break;}}
if(!needGet){onGet(data);}
else{var queryParam={ac:obj_+".get",id:data.id};opt.onGetData&&opt.onGetData(jf,queryParam);var ac=queryParam.ac;delete queryParam.ac;self.callSvr(ac,queryParam,onGet);}
function onGet(data)
{mCommon.setFormData(jf,data,{setOrigin:true});opt.onGet&&opt.onGet(data);}}
function delObject()
{var data=pageItf.formData;if(data==null||data.id==null){console.log("!!! delObject: no obj or obj.id");return;}
var ac=obj_+".del";self.callSvr(ac,{id:data.id},opt.onDel);}
var itf={refresh:function(){showObject(true);},del:delObject}
return itf;}}
jdModule("jdcloud.mui",JdcloudMuiName);function JdcloudMuiName()
{var self=this;var mCommon=jdModule("jdcloud.common");window.MUI=self;$.extend(MUI,mCommon);$.each(["intSort","numberSort","callSvr","callSvrSync","app_alert",],function(){window[this]=MUI[this];});}